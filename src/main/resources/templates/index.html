<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loto Master AI</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/airbnb.css">

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/fr.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <link th:href="@{/css/style.css}" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1050">
    <div id="winToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body fs-6">
                <i class="bi bi-emoji-sunglasses me-2"></i> F√©licitations ! Gain enregistr√©.
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

<nav class="navbar navbar-expand-lg navbar-dark navbar-custom sticky-top">
    <div class="container">
        <a class="navbar-brand d-flex align-items-center gap-2" href="#">
            <div class="bg-white text-primary rounded-3 d-flex align-items-center justify-content-center shadow-sm" style="width: 36px; height: 36px;">
                <i class="bi bi-dice-5-fill fs-5"></i>
            </div>
            <span>Loto Master AI</span>
        </a>

        <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarContent">

            <ul class="navbar-nav mx-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#modalAstro">
                        <i class="bi bi-stars text-warning me-1"></i>Mon Astro
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="https://www.fdj.fr/jeux-de-lotoTirage/loto" target="_blank">
                        <i class="bi bi-ticket-perforated me-1"></i>Site FDJ
                    </a>
                </li>
                <li class="nav-item" sec:authorize="hasRole('ADMIN')">
                    <a class="nav-link text-warning fw-bold" th:href="@{/admin}">
                        <i class="bi bi-shield-lock-fill me-1"></i>Admin
                    </a>
                </li>
            </ul>

            <div class="d-flex align-items-center">
                <div class="dropdown">
                    <a href="#" class="d-flex align-items-center text-white text-decoration-none dropdown-toggle user-dropdown-toggle gap-2" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <div class="text-end d-none d-md-block lh-1 me-1">
                            <div class="small text-white-50" style="font-size: 0.75rem;">Bonjour</div>
                            <div class="fw-bold" th:text="${prenom}">Joueur</div>
                        </div>
                        <div class="user-avatar shadow-sm">
                            <span th:text="${#strings.substring(prenom,0,1)}">U</span>
                        </div>
                    </a>

                    <ul class="dropdown-menu dropdown-menu-end dropdown-menu-custom" aria-labelledby="userDropdown">
                        <li>
                            <h6 class="dropdown-header">Mon Compte</h6>
                            <div class="px-3 pb-2 text-muted" style="font-size: 0.7rem;" th:if="${lastLogin != null}">
                                <i class="bi bi-clock-history me-1"></i>
                                Vu le <span th:text="${#temporals.format(lastLogin, 'dd/MM/yyyy √† HH:mm')}"></span>
                            </div>
                            <div class="px-3 pb-2 text-muted" style="font-size: 0.7rem;" th:if="${lastLogin == null}">
                                <i class="bi bi-stars me-1"></i> Premi√®re connexion !
                            </div>
                        </li>
                        <li><hr class="dropdown-divider m-0 mb-2"></li>

                        <li>
                            <a class="dropdown-item" th:href="@{/profile}">
                                <i class="bi bi-person-circle me-2 text-primary"></i>Mon Profil
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" th:href="@{/profile/stats}"> <i class="bi bi-bar-chart-fill me-2 text-info"></i>Mes Stats</a>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <form th:action="@{/logout}" method="post" class="m-0">
                                <button type="submit" class="dropdown-item text-danger fw-bold">
                                    <i class="bi bi-box-arrow-right me-2"></i>Se d√©connecter
                                </button>
                            </form>
                        </li>
                    </ul>
                </div>
            </div>

        </div>
    </div>
</nav>

<div class="container pb-5">

    <div th:if="${lastDraw != null}" class="card border-0 shadow mb-4 animate-up overflow-hidden text-white"
         style="background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);">

        <div class="position-absolute end-0 top-50 translate-middle-y opacity-10 pe-3 d-none d-md-block">
            <i class="bi bi-trophy-fill" style="font-size: 8rem;"></i>
        </div>

        <div class="card-body p-4 position-relative">
            <div class="row align-items-center">
                <div class="col-lg-4 text-center text-lg-start mb-3 mb-lg-0">
                    <div class="badge bg-white bg-opacity-25 mb-2 px-3 py-1 rounded-pill text-uppercase"
                         style="font-size: 0.7rem; letter-spacing: 1px;">
                        <i class="bi bi-megaphone-fill me-1"></i> R√©sultat Officiel
                    </div>
                    <h2 class="fw-bold mb-0 text-white">
                        <span th:text="${#temporals.format(lastDraw.dateTirage, 'EEEE d MMMM')}">Lundi 1 Janvier</span>
                    </h2>
                    <small class="text-white-50">Tirage FDJ</small>
                </div>

                <div class="col-lg-8">
                    <div class="d-flex justify-content-center align-items-center gap-2 gap-md-3 flex-wrap">
                        <span class="ball-display shadow" th:text="${lastDraw.boule1}">1</span>
                        <span class="ball-display shadow" th:text="${lastDraw.boule2}">2</span>
                        <span class="ball-display shadow" th:text="${lastDraw.boule3}">3</span>
                        <span class="ball-display shadow" th:text="${lastDraw.boule4}">4</span>
                        <span class="ball-display shadow" th:text="${lastDraw.boule5}">5</span>

                        <div style="width: 1px; height: 40px; background: rgba(255,255,255,0.3);" class="mx-2 d-none d-md-block"></div>

                        <span class="ball-display ball-chance shadow pulse-animation" th:text="${lastDraw.numeroChance}">C</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="alert alert-light border d-flex align-items-center justify-content-center shadow-sm py-2 mb-4 small animate-up" role="alert" id="infoPeriode" style="display: none !important;">
        <i class="bi bi-calendar-range me-2 text-primary"></i>
        <span>Historique : <strong id="nbTirages">0</strong> tirages (<span class="text-primary" id="dateMin">-</span> au <span class="text-primary" id="dateMax">-</span>)</span>
    </div>

    <div class="row g-3 mb-4 animate-up delay-1">
        <div class="col-md-4">
            <div class="card p-3 shadow-sm h-100 border-0 bg-white d-flex flex-row align-items-center justify-content-between">
                <div>
                    <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">D√©penses</small>
                    <h4 class="fw-bold text-danger mb-0">- <span th:text="${#numbers.formatDecimal(totalDepense, 1, 2)}">0.00</span> ‚Ç¨</h4>
                </div>
                <div class="bg-danger bg-opacity-10 text-danger rounded-circle p-2">
                    <i class="bi bi-arrow-down-right fs-4"></i>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card p-3 shadow-sm h-100 border-0 bg-white d-flex flex-row align-items-center justify-content-between">
                <div>
                    <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">Gains</small>
                    <h4 class="fw-bold text-success mb-0">+ <span th:text="${#numbers.formatDecimal(totalGains, 1, 2)}">0.00</span> ‚Ç¨</h4>
                </div>
                <div class="bg-success bg-opacity-10 text-success rounded-circle p-2">
                    <i class="bi bi-trophy fs-4"></i>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card p-3 shadow-sm h-100 border-0 d-flex flex-row align-items-center justify-content-between"
                 th:classappend="${solde >= 0} ? 'balance-positive' : 'balance-negative'">
                <div>
                    <small class="text-uppercase fw-bold opacity-75" style="font-size: 0.7rem;">Bilan Net</small>
                    <h4 class="fw-bold mb-0">
                        <span th:if="${solde > 0}">+</span><span th:text="${#numbers.formatDecimal(solde, 1, 2)}">0.00</span> ‚Ç¨
                    </h4>
                </div>
                <div class="bg-white bg-opacity-50 rounded-circle p-2">
                    <i class="bi bi-wallet2 fs-4"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4 border-primary border-opacity-25 animate-up delay-2">
        <div class="card-header bg-white py-3 border-bottom-0">
            <h5 class="mb-0 fw-bold text-primary"><i class="bi bi-cpu-fill me-2"></i>G√©n√©rateur & Simulateur</h5>
        </div>
        <div class="card-body bg-light rounded-bottom-4">
            <form id="formSimulateur">
                <div class="row g-2 align-items-end">
                    <div class="col-md-3">
                        <label class="small fw-bold text-muted mb-1">Date vis√©e</label>
                        <input type="date" class="form-control shadow-sm" id="simDate" required>
                    </div>

                    <div class="col"><input type="number" class="form-control text-center fw-bold sim-input shadow-sm" placeholder="N1"></div>
                    <div class="col"><input type="number" class="form-control text-center fw-bold sim-input shadow-sm" placeholder="N2"></div>
                    <div class="col"><input type="number" class="form-control text-center fw-bold sim-input shadow-sm" placeholder="N3"></div>
                    <div class="col"><input type="number" class="form-control text-center fw-bold sim-input shadow-sm" placeholder="N4"></div>
                    <div class="col"><input type="number" class="form-control text-center fw-bold sim-input shadow-sm" placeholder="N5"></div>

                    <div class="col-md-5">
                        <div class="d-flex gap-2">
                            <div class="input-group shadow-sm">
                                <span class="input-group-text bg-warning text-dark border-warning fw-bold">Qt√©</span>
                                <select class="form-select border-warning bg-white" id="pronoCount" style="max-width: 80px;">
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="5" selected>5</option>
                                    <option value="10">10</option>
                                </select>
                                <button type="button" id="btnMagic" class="btn btn-warning fw-bold text-dark flex-grow-1 btn-pulse">
                                    <i class="bi bi-magic me-1"></i> G√©n√©rer
                                </button>
                            </div>
                            <button type="submit" class="btn btn-dark shadow-sm" title="Analyser la saisie manuelle">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </form>

            <div id="pronoResult" class="mt-4 d-none fade-in">
                <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                    <h6 class="text-primary fw-bold mb-0">üîÆ Pronostics IA pour <span id="pronoDate"></span></h6>
                    <button class="btn btn-sm btn-link text-decoration-none text-muted" onclick="document.getElementById('pronoResult').classList.add('d-none')">Fermer</button>
                </div>
                <div id="pronoList" class="row g-3"></div>
            </div>

            <div id="simResult" class="mt-4 d-none fade-in"></div>
        </div>
    </div>

    <div class="card shadow-sm mb-4 animate-up delay-3">
        <div class="card-header bg-white py-3 border-bottom-0 d-flex justify-content-between align-items-center">
            <div>
                <h5 class="mb-0 fw-bold text-secondary"><i class="bi bi-ticket-detailed me-2"></i>Mes Grilles</h5>
                <small class="text-muted" th:if="${!bets.empty}">
                    <span th:text="${bets.size()}"></span> grilles jou√©es au total
                </small>
            </div>
            <a th:href="@{/bets/export/pdf}" class="btn btn-sm btn-outline-danger shadow-sm" target="_blank" title="Imprimer mes grilles">
                <i class="bi bi-file-earmark-pdf-fill me-1"></i>PDF
            </a>
            <button class="btn btn-sm btn-dark shadow-sm" data-bs-toggle="modal" data-bs-target="#modalAddBet">
                <i class="bi bi-plus-lg me-1"></i>Ajouter
            </button>
        </div>

        <div class="card-body p-0">
            <div class="bg-light bg-opacity-50 border-bottom p-3">
                <div class="row g-2 align-items-end">

                    <div class="col-md-4">
                        <label class="small fw-bold text-muted text-uppercase mb-1" style="font-size: 0.7rem;">
                            <i class="bi bi-calendar3 me-1"></i>P√©riode
                        </label>
                        <div class="input-group input-group-sm shadow-sm">
                            <input type="text" id="filterDateMin" class="form-control bg-white border-end-0" placeholder="Du...">
                            <span class="input-group-text bg-white border-start-0 border-end-0 text-muted">‚ûú</span>
                            <input type="text" id="filterDateMax" class="form-control bg-white border-start-0" placeholder="Au...">
                        </div>
                    </div>

                    <div class="col-md-3">
                        <label class="small fw-bold text-muted text-uppercase mb-1" style="font-size: 0.7rem;">
                            <i class="bi bi-activity me-1"></i>Statuts (Multi)
                        </label>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-white bg-white border w-100 text-start d-flex justify-content-between align-items-center shadow-sm"
                                    type="button" id="dropdownStatus" data-bs-toggle="dropdown" aria-expanded="false">
                                <span id="selectedStatusText">Tous les statuts</span>
                                <i class="bi bi-chevron-down small text-muted"></i>
                            </button>
                            <ul class="dropdown-menu w-100 p-2 shadow border-0" aria-labelledby="dropdownStatus">
                                <li>
                                    <div class="form-check">
                                        <input class="form-check-input status-checkbox" type="checkbox" value="Gagn√©" id="chkGagne" checked>
                                        <label class="form-check-label w-100 cursor-pointer" for="chkGagne"><i class="bi bi-trophy-fill text-success me-1"></i> Gagn√©</label>
                                    </div>
                                </li>
                                <li>
                                    <div class="form-check">
                                        <input class="form-check-input status-checkbox" type="checkbox" value="En attente" id="chkAttente" checked>
                                        <label class="form-check-label w-100 cursor-pointer" for="chkAttente"><i class="bi bi-hourglass-split text-warning me-1"></i> En attente</label>
                                    </div>
                                </li>
                                <li>
                                    <div class="form-check">
                                        <input class="form-check-input status-checkbox" type="checkbox" value="Rembours√©" id="chkRembourse" checked>
                                        <label class="form-check-label w-100 cursor-pointer" for="chkRembourse"><i class="bi bi-arrow-repeat text-info me-1"></i> Rembours√©</label>
                                    </div>
                                </li>
                                <li>
                                    <div class="form-check">
                                        <input class="form-check-input status-checkbox" type="checkbox" value="Perdu" id="chkPerdu" checked>
                                        <label class="form-check-label w-100 cursor-pointer" for="chkPerdu"><i class="bi bi-x-circle text-muted me-1"></i> Perdu</label>
                                    </div>
                                </li>
                                <li><hr class="dropdown-divider my-1"></li>
                                <li><button class="btn btn-xs btn-link text-decoration-none p-0 ps-1" onclick="$('.status-checkbox').prop('checked', true).trigger('change')">Tout cocher</button></li>
                            </ul>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <label class="small fw-bold text-muted text-uppercase mb-1" style="font-size: 0.7rem;">
                            <i class="bi bi-currency-euro me-1"></i>Gain Min.
                        </label>
                        <input type="number" id="filterGain" class="form-control form-control-sm shadow-sm border-0" placeholder="ex: 10" step="0.5">
                    </div>

                    <div class="col-md-2 d-grid">
                        <button id="btnResetFilters" class="btn btn-sm btn-outline-secondary border-0 bg-white shadow-sm h-100">
                            <i class="bi bi-arrow-counterclockwise me-1"></i>Effacer
                        </button>
                    </div>
                </div>
            </div>
            <div class="table-responsive">
                <table id="betsTable" class="table table-hover align-middle mb-0" style="border-collapse: separate; border-spacing: 0;">
                    <thead class="bg-light small text-uppercase text-secondary">
                    <tr>
                        <th class="ps-4 py-3 border-0">Date</th>
                        <th class="text-center border-0">Combinaison</th>
                        <th class="text-center border-0">Statut</th>
                        <th class="text-end border-0">Gain</th>
                        <th class="text-end pe-4 border-0">Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:if="${#lists.isEmpty(bets)}">
                        <td colspan="5" class="text-center py-5">
                            <div class="text-muted d-flex flex-column align-items-center">
                                <i class="bi bi-ticket-perforated display-4 mb-3 opacity-25"></i>
                                <p class="mb-0">Aucune grille enregistr√©e.</p>
                                <button class="btn btn-sm btn-outline-primary mt-2" data-bs-toggle="modal" data-bs-target="#modalAddBet">
                                    Ajouter ma premi√®re grille
                                </button>
                            </div>
                        </td>
                    </tr>

                    <tr th:each="bet : ${bets}"
                        th:classappend="${bet.dateJeu.isEqual(#temporals.createToday())} ? 'table-warning border-start border-4 border-warning' : ''">

                        <td class="ps-4" th:data-order="${bet.dateJeu}">
                            <div class="d-flex flex-column">
                                <span class="fw-bold text-dark" th:text="${#temporals.format(bet.dateJeu, 'dd MMM yyyy')}">Date</span>
                                <small class="text-muted text-capitalize" th:text="${#temporals.dayOfWeekName(bet.dateJeu)}">Jour</small>
                            </div>
                        </td>

                        <td class="text-center">
                            <div class="d-inline-flex align-items-center gap-1"
                                 th:with="lotoTirage=${draws != null ? draws.get(bet.dateJeu) : null}">

        <span class="badge rounded-circle shadow-sm loto-badge"
              th:text="${bet.b1}"
              th:classappend="${lotoTirage == null} ? 'bg-white border border-secondary text-dark' :
                              (${#lists.contains(lotoTirage.boules, bet.b1)} ? 'bg-success border-success text-white' : 'bg-light border-light text-muted opacity-50')">
        </span>

                                <span class="badge rounded-circle shadow-sm loto-badge"
                                      th:text="${bet.b2}"
                                      th:classappend="${lotoTirage == null} ? 'bg-white border border-secondary text-dark' :
                              (${#lists.contains(lotoTirage.boules, bet.b2)} ? 'bg-success border-success text-white' : 'bg-light border-light text-muted opacity-50')">
        </span>

                                <span class="badge rounded-circle shadow-sm loto-badge"
                                      th:text="${bet.b3}"
                                      th:classappend="${lotoTirage == null} ? 'bg-white border border-secondary text-dark' :
                              (${#lists.contains(lotoTirage.boules, bet.b3)} ? 'bg-success border-success text-white' : 'bg-light border-light text-muted opacity-50')">
        </span>

                                <span class="badge rounded-circle shadow-sm loto-badge"
                                      th:text="${bet.b4}"
                                      th:classappend="${lotoTirage == null} ? 'bg-white border border-secondary text-dark' :
                              (${#lists.contains(lotoTirage.boules, bet.b4)} ? 'bg-success border-success text-white' : 'bg-light border-light text-muted opacity-50')">
        </span>

                                <span class="badge rounded-circle shadow-sm loto-badge"
                                      th:text="${bet.b5}"
                                      th:classappend="${lotoTirage == null} ? 'bg-white border border-secondary text-dark' :
                              (${#lists.contains(lotoTirage.boules, bet.b5)} ? 'bg-success border-success text-white' : 'bg-light border-light text-muted opacity-50')">
        </span>

                                <span class="badge rounded-circle shadow-sm loto-badge ms-2"
                                      th:text="${bet.chance}"
                                      th:classappend="${lotoTirage == null} ? 'bg-danger text-white' :
                              (${lotoTirage.numeroChance == bet.chance} ? 'bg-danger border-danger text-white glowing-border' : 'bg-light border-light text-danger opacity-50')">
        </span>

                                <i th:if="${lotoTirage != null}" class="bi bi-info-circle-fill text-muted ms-1 small"
                                   data-bs-toggle="tooltip"
                                   th:title="'Tirage : ' + ${lotoTirage.boules} + ' [C' + ${lotoTirage.numeroChance} + ']'"></i>
                            </div>
                        </td>

                        <td class="text-center">
                    <span th:if="${bet.gain == null}" class="badge bg-warning bg-opacity-10 text-warning border border-warning">
                        <i class="bi bi-hourglass-split me-1"></i>En attente
                    </span>
                            <span th:if="${bet.gain != null && bet.gain > bet.mise}" class="badge bg-success bg-opacity-10 text-success border border-success">
                        <i class="bi bi-trophy-fill me-1"></i>Gagn√©
                    </span>
                            <span th:if="${bet.gain != null && bet.gain == bet.mise}" class="badge bg-info bg-opacity-10 text-info border border-info">
                        <i class="bi bi-arrow-repeat me-1"></i>Rembours√©
                    </span>
                            <span th:if="${bet.gain != null && bet.gain < bet.mise}" class="badge bg-light text-muted border">
                        <i class="bi bi-x-circle me-1"></i>Perdu
                    </span>
                        </td>

                        <td class="text-end fw-bold">
                            <span th:if="${bet.gain == null}" class="text-muted">-</span>
                            <span th:if="${bet.gain != null && bet.gain > 0}" class="text-success" th:text="'+ ' + ${#numbers.formatDecimal(bet.gain, 1, 2)} + ' ‚Ç¨'"></span>
                            <span th:if="${bet.gain != null && bet.gain == 0}" class="text-muted small text-decoration-line-through" th:text="${bet.mise} + ' ‚Ç¨'"></span>
                        </td>

                        <td class="text-end pe-4">
                            <div class="dropdown">
                                <button class="btn btn-sm btn-light rounded-circle" type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-three-dots-vertical"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end shadow border-0">
                                    <li>
                                        <button class="dropdown-item small"
                                                data-bs-toggle="modal" data-bs-target="#modalUpdateGain"
                                                th:onclick="'setBetId(' + ${bet.id} + ')'">
                                            <i class="bi bi-pencil me-2 text-primary"></i>Saisir R√©sultat
                                        </button>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <form th:action="@{/bets/delete}" method="post" onsubmit="return confirm('Supprimer cette grille ?');">
                                            <input type="hidden" name="betId" th:value="${bet.id}">
                                            <button type="submit" class="dropdown-item small text-danger">
                                                <i class="bi bi-trash me-2"></i>Supprimer
                                            </button>
                                        </form>
                                    </li>
                                </ul>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <style>
            .loto-badge {
                width: 28px; height: 28px;
                line-height: 24px;
                font-size: 0.85rem;
                display: inline-block;
                padding: 0;
                text-align: center;
            }
        </style>
    </div>

    <div class="accordion mb-4 animate-up delay-4" id="statsAccordion">
        <div class="accordion-item border-0 shadow-sm rounded-3 overflow-hidden">
            <h2 class="accordion-header" id="headingStats">
                <button class="accordion-button collapsed fw-bold text-secondary bg-white" type="button" data-bs-toggle="collapse" data-bs-target="#collapseStats">
                    <i class="bi bi-bar-chart-fill me-2 text-primary"></i> Voir les Statistiques D√©taill√©es
                </button>
            </h2>
            <div id="collapseStats" class="accordion-collapse collapse" data-bs-parent="#statsAccordion">
                <div class="accordion-body bg-white">
                    <div class="row mb-3">
                        <div class="col-md-12 text-center">
                            <div class="btn-group shadow-sm" role="group">
                                <button type="button" class="btn btn-outline-primary btn-filter active px-4" data-jour="">Tous</button>
                                <button type="button" class="btn btn-outline-primary btn-filter px-3" data-jour="MONDAY">Lundi</button>
                                <button type="button" class="btn btn-outline-primary btn-filter px-3" data-jour="WEDNESDAY">Mercredi</button>
                                <button type="button" class="btn btn-outline-primary btn-filter px-3" data-jour="SATURDAY">Samedi</button>
                            </div>
                        </div>
                    </div>

                    <ul class="nav nav-pills justify-content-center bg-light p-2 rounded-3 mb-3 shadow-sm" id="graphTabs" role="tablist" style="max-width: fit-content; margin: 0 auto;">
                        <li class="nav-item">
                            <button class="nav-link active rounded-3 px-4 fw-bold" id="tab-main" data-bs-toggle="pill" data-target="main">üîµ Boules</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link rounded-3 px-4 fw-bold text-danger" id="tab-chance" data-bs-toggle="pill" data-target="chance">üî¥ Chance</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link rounded-3 px-4 fw-bold text-success" id="tab-heat" data-bs-toggle="pill" data-target="heat">üå°Ô∏è Heatmap</button>
                        </li>
                    </ul>

                    <div class="mt-3">
                        <div id="searchContainerMain" class="mb-3 search-container mx-auto" style="max-width: 500px;">
                            <div class="input-group shadow-sm">
                                <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
                                <input type="text" class="form-control border-start-0" id="searchNum" placeholder="Filtrer...">
                                <button class="btn btn-outline-secondary btn-reset" type="button">‚úñ</button>
                            </div>
                        </div>
                        <div id="searchContainerChance" class="mb-3 search-container d-none mx-auto" style="max-width: 500px;">
                            <div class="input-group shadow-sm">
                                <span class="input-group-text bg-white border-end-0 text-danger"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control border-start-0" id="searchChance" placeholder="Filtrer Chance...">
                                <button class="btn btn-outline-secondary btn-reset" type="button">‚úñ</button>
                            </div>
                        </div>

                        <div class="position-relative" style="min-height: 300px;">
                            <canvas id="scatterChart"></canvas>
                        </div>
                        <div id="heatmapContainer" class="d-none mt-4 fade-in">
                            <div class="d-flex justify-content-center flex-wrap gap-2" id="heatmapGrid" style="max-width: 700px; margin: 0 auto;"></div>
                        </div>
                    </div>

                    <div class="row g-4 mt-2">
                        <div class="col-lg-6">
                            <div class="card h-100 shadow-sm border-primary border-opacity-25">
                                <div class="card-header bg-primary bg-opacity-10 text-primary border-bottom-0 py-2"><h6 class="mb-0 fw-bold">Top Boules</h6></div>
                                <div class="card-body"><div class="row g-3"><div class="col-6"><ul class="list-group list-group-flush small-list" id="mainTopFreq"></ul></div><div class="col-6"><ul class="list-group list-group-flush small-list" id="mainTopGap"></ul></div></div></div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="card h-100 shadow-sm border-danger border-opacity-25">
                                <div class="card-header bg-danger bg-opacity-10 text-danger border-bottom-0 py-2"><h6 class="mb-0 fw-bold">Top Chance</h6></div>
                                <div class="card-body"><div class="row g-3"><div class="col-6"><ul class="list-group list-group-flush small-list" id="chanceTopFreq"></ul></div><div class="col-6"><ul class="list-group list-group-flush small-list" id="chanceTopGap"></ul></div></div></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card border-0 shadow-sm mt-4">
            <div class="card-header bg-white fw-bold d-flex justify-content-between align-items-center">
                <span><i class="bi bi-radar me-2 text-primary"></i>Profil Statistique</span>

                <button type="button" class="btn btn-sm btn-outline-primary rounded-circle"
                        style="width: 24px; height: 24px; padding: 0; line-height: 0;"
                        data-bs-toggle="popover"
                        data-bs-html="true"
                        data-bs-trigger="focus"
                        title="üß† Comment lire ce graphique ?"
                        data-bs-content="
                <div class='small text-start'>
                    <p class='mb-2'>Ce radar compare la r√©alit√© (Bleu) √† la th√©orie (Gris).</p>
                    <ul class='ps-3 mb-0'>
                        <li><b>Pairs :</b> Num√©ros 2, 4, 6...</li>
                        <li><b>Impairs :</b> Num√©ros 1, 3, 5...</li>
                        <li><b>Grands :</b> Sup√©rieurs √† 25.</li>
                        <li><b>Petits :</b> De 1 √† 25.</li>
                        <li><b>Finales Basses :</b> Finissant par 0, 1, 2, 3 ou 4 (ex: 12, 40).</li>
                    </ul>
                    <hr class='my-2'>
                    <i>Astuce : Si le bleu d√©passe le gris sur une pointe, c'est une tendance forte !</i>
                </div>">
                    <i class="bi bi-question"></i>
                </button>
            </div>
            <div class="card-body">
                <div style="height: 400px; position: relative; width: 100%;">
                    <canvas id="radarChart"></canvas>
                </div>

                <div id="radarAnalysis" class="mt-3 text-center small bg-light p-2 rounded border"></div>
            </div>
        </div>

        <script>
            document.addEventListener("DOMContentLoaded", function() {
                fetch('/api/loto/graph-data')
                    .then(response => response.json())
                    .then(data => {
                        const container = document.getElementById('networkGraph');

                        const options = {
                            nodes: {
                                shape: 'dot',
                                size: 20,
                                font: {
                                    size: 16,
                                    color: '#000000', // Texte noir pour lisibilit√©
                                    strokeWidth: 2,   // Contour blanc autour du texte
                                    strokeColor: '#ffffff'
                                },
                                borderWidth: 2,
                                shadow: true
                            },
                            edges: {
                                width: 1,
                                color: { color: '#cbd5e1', highlight: '#4F46E5', opacity: 0.6 },
                                smooth: {
                                    type: 'continuous' // Courbes plus douces
                                }
                            },
                            physics: {
                                enabled: true,
                                solver: 'forceAtlas2Based', // Algorithme plus stable que BarnesHut
                                forceAtlas2Based: {
                                    gravitationalConstant: -50, // R√©pulsion mod√©r√©e
                                    centralGravity: 0.01,
                                    springLength: 100,
                                    springConstant: 0.08
                                },
                                stabilization: {
                                    enabled: true,
                                    iterations: 1000, // On pr√©-calcule 1000 fois avant d'afficher
                                    updateInterval: 25,
                                    onlyDynamicEdges: false,
                                    fit: true
                                },
                                minVelocity: 0.75 // S'arr√™te d√®s que √ßa bouge doucement
                            },
                            interaction: {
                                hover: true,
                                dragNodes: true, // On peut bouger les boules manuellement
                                zoomView: true,
                                dragView: true
                            }
                        };

                        // Cr√©ation du r√©seau
                        var network = new vis.Network(container, data, options);

                        // --- L'ASTUCE MAGIQUE ---
                        // Une fois que le graph est stable, on coupe la physique !
                        network.on("stabilizationIterationsDone", function () {
                            network.setOptions( { physics: false } );
                        });

                        // Si on clique sur une boule, on r√©active un peu la physique pour que √ßa bouge fluide
                        network.on("dragStart", function (params) {
                            network.setOptions( { physics: true } );
                        });

                        // Quand on l√¢che, on re-fige
                        network.on("dragEnd", function (params) {
                            network.setOptions( { physics: false } );
                        });
                    });
            });
        </script>
    </div>

    <div class="modal fade" id="modalAstro" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-moon-stars-fill me-2"></i>Analyse Astrologique</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body bg-light">
                    <form id="formAstro">
                        <div class="row g-2 mb-3">
                            <div class="col-6"><label class="form-label small fw-bold text-muted">Date Naissance</label><input type="date" id="astroDate" class="form-control" th:value="${birthDate}" required></div>
                            <div class="col-6"><label class="form-label small fw-bold text-muted">Heure</label><input type="time" id="astroTime" class="form-control" th:value="${birthTime}" required></div>
                            <div class="col-6"><label class="form-label small fw-bold text-muted">Ville</label><input type="text" id="astroVille" class="form-control" placeholder="ex: Paris" th:value="${birthCity}" required></div>
                            <div class="col-6">
                                <label class="form-label small fw-bold text-muted">Signe</label>
                                <select id="astroSigne" class="form-select" required>
                                    <option th:each="s : ${ {'BELIER','TAUREAU','GEMEAUX','CANCER','LION','VIERGE','BALANCE','SCORPION','SAGITTAIRE','CAPRICORNE','VERSEAU','POISSONS'} }"
                                            th:value="${s}" th:text="${s}" th:selected="${astroSigne == s}"></option>
                                </select>
                            </div>
                        </div>
                        <div class="d-grid gap-2 mt-4">
                            <button type="submit" class="btn btn-outline-primary">üîÆ Voir mes num√©ros astraux</button>
                            <button type="button" id="btnHybridAlgo" class="btn btn-primary fw-bold shadow-sm py-2">üöÄ Lancer l'Algorithme Hybride</button>
                        </div>
                    </form>
                    <div id="astroResult" class="d-none mt-4 text-center fade-in">
                        <div class="p-3 bg-white rounded-3 shadow-sm border">
                            <h6 class="text-primary fw-bold text-uppercase mb-1" id="astroTitle">-</h6>
                            <p class="small text-muted mb-3">Chemin de Vie : <strong id="astroPath"></strong> | √âl√©ment : <strong id="astroElement"></strong></p>
                            <div class="alert alert-info py-2 fst-italic small mb-3" id="astroPhrase"></div>
                            <p class="mb-2 fw-bold small text-uppercase text-secondary">Vos Num√©ros Porte-Bonheur</p>
                            <div class="d-flex justify-content-center gap-2 mb-3" id="astroBalls"></div>
                            <button class="btn btn-sm btn-dark w-100" id="btnCopyAstro"><i class="bi bi-arrow-down-circle me-1"></i> Copier dans le simulateur</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalAddBet" tabindex="-1">
        <div class="modal-dialog">
            <form th:action="@{/bets/add}" method="post" class="modal-content">
                <div class="modal-header"><h5 class="modal-title">üìù Enregistrer une grille</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="mb-3"><label class="form-label small">Date du lotoTirage</label><input type="date" name="dateJeu" class="form-control" required th:value="${#dates.format(#dates.createNow(), 'yyyy-MM-dd')}"></div>
                    <label class="form-label small">Num√©ros jou√©s</label>
                    <div class="input-group mb-3"><input type="number" name="b1" class="form-control" placeholder="1" required><input type="number" name="b2" class="form-control" placeholder="2" required><input type="number" name="b3" class="form-control" placeholder="3" required><input type="number" name="b4" class="form-control" placeholder="4" required><input type="number" name="b5" class="form-control" placeholder="5" required><input type="number" name="chance" class="form-control border-danger text-danger fw-bold" placeholder="C" required></div>
                    <div class="mb-3"><label class="form-label small">Co√ªt de la grille (‚Ç¨)</label><input type="number" step="0.01" name="mise" class="form-control" value="2.20" required></div>
                </div>
                <div class="modal-footer"><button type="submit" class="btn btn-primary">Enregistrer</button></div>
            </form>
        </div>
    </div>
    <div class="modal fade" id="modalUpdateGain" tabindex="-1">
        <div class="modal-dialog modal-sm">
            <form th:action="@{/bets/update}" method="post" class="modal-content">
                <div class="modal-header bg-success text-white"><h5 class="modal-title fs-6">üí∞ R√©sultat</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body"><input type="hidden" id="gainBetId" name="betId"><div class="mb-3"><label class="form-label small">Gain (‚Ç¨) ?</label><input type="number" step="0.10" name="gain" class="form-control fw-bold" placeholder="0.00" required></div></div>
                <div class="modal-footer p-1"><button type="submit" class="btn btn-success w-100">Valider</button></div>
            </form>
        </div>
    </div>

</div>

<footer class="footer mt-auto">
    <div class="container">
        <div class="row align-items-center">

            <div class="col-md-6 text-center text-md-start mb-3 mb-md-0">
                <p class="mb-0 fw-bold text-dark">Loto Master AI <span class="badge bg-light text-secondary border ms-1">v2.0</span></p>
                <small class="d-block mt-1">
                    &copy; <span th:text="${#dates.format(#dates.createNow(), 'yyyy')}">2025</span> - D√©velopp√© avec <i class="bi bi-heart-fill text-danger mx-1" style="font-size:10px;"></i> et Spring Boot.
                </small>
            </div>

            <div class="col-md-6 text-center text-md-end">
                <div class="mb-2">
                    <a href="#" class="mx-2 small">Mentions L√©gales</a>
                    <a href="#" class="mx-2 small">Confidentialit√©</a>
                    <a href="#" class="mx-2 small">Contact</a>
                </div>
                <div>
                    <a href="#" class="footer-social-btn"><i class="bi bi-github"></i></a>
                    <a href="#" class="footer-social-btn"><i class="bi bi-twitter"></i></a>
                    <a href="#" class="footer-social-btn"><i class="bi bi-linkedin"></i></a>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12 text-center">
                <div class="p-2 rounded bg-light border d-inline-block">
                    <small class="text-muted fst-italic">
                        <i class="bi bi-exclamation-triangle-fill text-warning me-1"></i>
                        Les jeux d'argent pr√©sentent des risques : endettement, isolement, d√©pendance. Pour √™tre aid√©, appelez le 09 74 75 13 13 (appel non surtax√©).
                    </small>
                </div>
            </div>
        </div>
    </div>
</footer>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">

<script th:inline="none">
    $(document).ready(function() {
        // 1. Initialisation de la table
        var table = $('#betsTable').DataTable({
            "language": {
                "url": "//cdn.datatables.net/plug-ins/1.13.6/i18n/fr-FR.json",
                "paginate": { "previous": "<i class='bi bi-chevron-left'></i>", "next": "<i class='bi bi-chevron-right'></i>" },
                "zeroRecords": "<div class='py-4 text-muted'><i class='bi bi-search display-6 mb-2'></i><br>Aucune grille ne correspond √† ces filtres.</div>"
            },
            "order": [[ 0, "desc" ]],
            "pageLength": 5,
            "lengthChange": false,
            "searching": true,
            "dom": 'rt<"d-flex flex-column align-items-center mt-3"ip>'
        });

        // 2. Initialisation Flatpickr
        const filterConfig = {
            locale: "fr", dateFormat: "Y-m-d", altInput: true, altFormat: "j F Y", allowInput: true,
            onChange: function() { table.draw(); }
        };
        flatpickr("#filterDateMin", filterConfig);
        flatpickr("#filterDateMax", filterConfig);

        // 3. FONCTION DE FILTRAGE INTELLIGENTE
        $.fn.dataTable.ext.search.push(
            function(settings, data, dataIndex) {

                // --- A. DATE ---
                var min = $('#filterDateMin').val();
                var max = $('#filterDateMax').val();
                var dateRow = table.row(dataIndex).node().cells[0].getAttribute('data-order');

                if (!((min === "" && max === "") || (min === "" && dateRow <= max) || (min <= dateRow && max === "") || (min <= dateRow && dateRow <= max))) {
                    return false;
                }

                // --- B. STATUT (MULTI-SELECTION) ---
                // On r√©cup√®re la liste des valeurs coch√©es
                var selectedStatuses = [];
                $('.status-checkbox:checked').each(function() {
                    selectedStatuses.push($(this).val());
                });

                var statusRowText = data[2]; // Colonne Statut

                // Si aucun statut coch√©, on n'affiche rien (ou tout, selon la logique voulue, ici j'assume rien)
                // Si la ligne ne contient AUCUN des statuts coch√©s, on masque
                var matchStatus = false;
                if (selectedStatuses.length > 0) {
                    for (var i = 0; i < selectedStatuses.length; i++) {
                        if (statusRowText.includes(selectedStatuses[i])) {
                            matchStatus = true;
                            break;
                        }
                    }
                }

                if (!matchStatus) return false;

                // --- C. FILTRE GAIN MINIMUM (STRICT) ---
                var gainInput = $('#filterGain').val();

                if (gainInput !== "") {
                    var gainMin = parseFloat(gainInput);
                    var statusText = data[2]; // Colonne Statut (Index 2)

                    // 1. S√âCURIT√â : Si on filtre par gain, on vire les Perdants et En attente
                    // M√™me si le script lit "2.20" (mise barr√©e), on le force √† masquer la ligne
                    if (statusText.includes("Perdu") || statusText.includes("En attente")) {
                        return false;
                    }

                    // 2. Nettoyage du montant pour les Gagnants / Rembours√©s
                    var rawGain = data[3];

                    // On nettoie : on garde chiffres, virgule, point et le signe moins
                    // Ex: "+ 145,20 ‚Ç¨" devient "145.20"
                    var cleanGainString = rawGain.replace(/[^\d,-]/g, '').replace(',', '.');
                    var gainRow = parseFloat(cleanGainString);

                    // Si le parsing √©choue ou si le montant est inf√©rieur au filtre
                    if (isNaN(gainRow) || gainRow < gainMin) {
                        return false;
                    }
                }

                return true;
            }
        );

        // 4. √âcouteurs d'√©v√©nements

        // Au changement d'une checkbox
        $('.status-checkbox').on('change', function() {
            // Mise √† jour du texte du bouton (UX)
            var checkedCount = $('.status-checkbox:checked').length;
            var totalCount = $('.status-checkbox').length;

            if(checkedCount === totalCount) {
                $('#selectedStatusText').text('Tous les statuts');
            } else if (checkedCount === 0) {
                $('#selectedStatusText').text('Aucun s√©lectionn√©');
            } else {
                $('#selectedStatusText').text(checkedCount + ' filtres actifs');
            }

            table.draw();
        });

        $('#filterGain').on('keyup change', function() {
            table.draw();
        });

        // 5. Reset
        $('#btnResetFilters').on('click', function() {
            $('#filterDateMin').val('').next().val('');
            $('#filterDateMax').val('').next().val('');
            $('#filterGain').val('');

            // On recoche tout par d√©faut
            $('.status-checkbox').prop('checked', true).trigger('change');

            document.querySelector("#filterDateMin")._flatpickr.clear();
            document.querySelector("#filterDateMax")._flatpickr.clear();

            table.draw();
        });
    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Configuration commune
        const lotoConfig = {
            "locale": "fr", // Langue fran√ßaise
            "dateFormat": "Y-m-d", // Format envoy√© au serveur
            "altInput": true, // Affiche une date plus lisible
            "altFormat": "l j F Y", // ex: Lundi 12 Janvier 2025
            "allowInput": true,
            "disable": [
                function(date) {
                    // Renvoyer 'true' pour d√©sactiver un jour.
                    // On d√©sactive tout ce qui N'EST PAS (1=Lun, 3=Mer, 6=Sam)
                    return (date.getDay() !== 1 && date.getDay() !== 3 && date.getDay() !== 6);
                }
            ],
            // Optionnel : Mettre en √©vidence les jours disponibles
            "onDayCreate": function(dObj, dStr, fp, dayElem) {
                // Si c'est un jour de Loto, on ajoute une petite puce color√©e
                if (dayElem.dateObj.getDay() === 1 || dayElem.dateObj.getDay() === 3 || dayElem.dateObj.getDay() === 6) {
                    dayElem.innerHTML += "<span style='display:block; width:4px; height:4px; background:#4F46E5; border-radius:50%; margin:0 auto;'></span>";
                }
            }
        };

        // 1. Appliquer sur le Simulateur
        flatpickr("#simDate", lotoConfig);

        // 2. Appliquer sur le Modal d'ajout (via le nom ou la classe)
        // On s√©lectionne l'input date dans le modal
        flatpickr("input[name='dateJeu']", lotoConfig);

        // 3. Appliquer sur le Modal Astro (si besoin)
        flatpickr("#astroDate", {
            "locale": "fr",
            "dateFormat": "Y-m-d",
            "altInput": true,
            "altFormat": "j F Y"
            // Pas de restriction de jours pour l'anniversaire !
        });
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script th:src="@{/js/app.js}"></script>
<script>function setBetId(id){document.getElementById('gainBetId').value=id;}</script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.css"/>
<script src="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.js.iife.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // On v√©rifie si l'utilisateur a d√©j√† vu le tour (via localStorage)
        if (!localStorage.getItem('lotoTourSeen')) {

            const driver = window.driver.js.driver;
            const driverObj = driver({
                showProgress: true,
                steps: [
                    { element: '.navbar-brand', popover: { title: 'Bienvenue !', description: 'D√©couvrez Loto Master AI en 30 secondes.' } },
                    { element: '#formSimulateur', popover: { title: 'Le Cerveau IA', description: 'C\'est ici que tout commence. Entrez une date, choisissez une quantit√© et laissez l\'IA calculer.' } },
                    { element: '#btnMagic', popover: { title: 'G√©n√©ration Magique', description: 'Cliquez ici pour g√©n√©rer des grilles optimis√©es par nos algorithmes.' } },
                    { element: '#statsAccordion', popover: { title: 'Analysez tout', description: 'Consultez les statistiques d√©taill√©es, les heatmaps et les graphiques ici.' } },
                    { element: '#betsTable', popover: { title: 'Vos Grilles', description: 'Retrouvez ici vos paris enregistr√©s et v√©rifiez vos gains.' } }
                ],
                onDestroyed: () => {
                    localStorage.setItem('lotoTourSeen', 'true'); // On ne le montre plus
                }
            });

            driverObj.drive();
        }
    });
</script>
<script>
    document.addEventListener("DOMContentLoaded", function() {

        // --- FONCTION : Trouver la prochaine date de Loto ---
        function getNextLotoDate() {
            let date = new Date();
            // On boucle jusqu'√† trouver un jour valide (1=Lun, 3=Mer, 6=Sam)
            while (true) {
                let day = date.getDay();
                if (day === 1 || day === 3 || day === 6) {
                    return date;
                }
                // Sinon on ajoute 1 jour
                date.setDate(date.getDate() + 1);
            }
        }

        // --- FONCTION : Forcer la date si vide ---
        function ensureDateIsSet() {
            const input = document.getElementById('simDate');
            // Si le champ est vide
            if (!input.value) {
                const nextDate = getNextLotoDate();
                // On met √† jour via l'instance Flatpickr pour garder le formatage
                if (input._flatpickr) {
                    input._flatpickr.setDate(nextDate, true); // true = d√©clenche les √©v√©nements de changement
                }
            }
        }

        // --- NOUVELLE FONCTION : Transf√©rer un prono vers la modale d'ajout ---
        window.preparerGrille = function(b1, b2, b3, b4, b5, chance) {

            // 1. R√©cup√©rer la date s√©lectionn√©e dans le simulateur
            const simDateValue = document.getElementById('simDate').value;

            // 2. Remplir la date dans la modale (compatible Flatpickr)
            const modalDateInput = document.querySelector("#modalAddBet input[name='dateJeu']");
            if (modalDateInput && modalDateInput._flatpickr) {
                modalDateInput._flatpickr.setDate(simDateValue, true);
            } else if (modalDateInput) {
                modalDateInput.value = simDateValue;
            }

            // 3. Remplir les boules
            // On cible le formulaire dans la modale
            const form = document.querySelector("#modalAddBet form");
            if(form) {
                form.querySelector("input[name='b1']").value = b1;
                form.querySelector("input[name='b2']").value = b2;
                form.querySelector("input[name='b3']").value = b3;
                form.querySelector("input[name='b4']").value = b4;
                form.querySelector("input[name='b5']").value = b5;
                form.querySelector("input[name='chance']").value = chance;
            }

            // 4. Ouvrir la modale Bootstrap
            const modalEl = document.getElementById('modalAddBet');
            // 'getOrCreateInstance' est plus s√ªr pour √©viter les conflits
            const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
            modal.show();
        };

        // --- Configuration Flatpickr ---
        const lotoConfig = {
            "locale": "fr",
            "dateFormat": "Y-m-d",
            "altInput": true,
            "altFormat": "l j F Y",
            "allowInput": true,
            "defaultDate": getNextLotoDate(), // <--- AJOUT : Pr√©-remplit au chargement !
            "disable": [
                function(date) {
                    return (date.getDay() !== 1 && date.getDay() !== 3 && date.getDay() !== 6);
                }
            ],
            "onDayCreate": function(dObj, dStr, fp, dayElem) {
                if (dayElem.dateObj.getDay() === 1 || dayElem.dateObj.getDay() === 3 || dayElem.dateObj.getDay() === 6) {
                    dayElem.innerHTML += "<span style='display:block; width:4px; height:4px; background:#4F46E5; border-radius:50%; margin:0 auto;'></span>";
                }
            }
        };

        // 1. Initialisation Simulateur
        flatpickr("#simDate", lotoConfig);

        // 2. Initialisation Modal Ajout
        flatpickr("input[name='dateJeu']", lotoConfig);

        // 3. Initialisation Astro
        flatpickr("#astroDate", {
            "locale": "fr",
            "dateFormat": "Y-m-d",
            "altInput": true,
            "altFormat": "j F Y"
        });

        // --- LISTENERS : On v√©rifie la date au clic ---

        // Bouton G√©n√©rer (Magic)
        const btnMagic = document.getElementById('btnMagic');
        if (btnMagic) {
            // On utilise 'mousedown' pour √™tre s√ªr que la date se met AVANT que le click ne lance le calcul
            btnMagic.addEventListener('mousedown', ensureDateIsSet);
        }

        // Bouton Analyser (Submit du formulaire)
        const formSimulateur = document.getElementById('formSimulateur');
        if (formSimulateur) {
            formSimulateur.addEventListener('submit', function() {
                ensureDateIsSet();
            });
            // Aussi sur le bouton loupe sp√©cifiquement
            const btnSearch = formSimulateur.querySelector('button[type="submit"]');
            if(btnSearch) btnSearch.addEventListener('mousedown', ensureDateIsSet);
        }
    });
</script>
</body>
</html>