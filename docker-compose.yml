services:
  # ----------------------------------------------------
  # 1. BASE DE DONNÉES (Inchangé)
  # ----------------------------------------------------
  loto_db:
    image: postgres:15
    container_name: loto_db
    environment:
      POSTGRES_DB: lotodb
      POSTGRES_USER: loto
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      TZ: Europe/Paris
    volumes:
      - pgdata:/var/lib/postgresql/data
    restart: always
    deploy:
      resources:
        limits:
          memory: 512M
    ports:
      - "5433:5432"

  # ----------------------------------------------------
  # SAUVEGARDE AUTOMATIQUE (Toutes les nuits à 3h00)
  # ----------------------------------------------------
  db_backup:
    image: prodrigestivill/postgres-backup-local
    container_name: loto_db_backup
    restart: always
    depends_on:
      - loto_db
    environment:
      POSTGRES_HOST: loto_db
      POSTGRES_DB: lotodb
      POSTGRES_USER: loto
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      SCHEDULE: "@daily"
      BACKUP_KEEP_DAYS: 7
      TZ: Europe/Paris
    volumes:
      - ./backups:/backups

  # ----------------------------------------------------
  # 2. APPLICATION SPRING BOOT (Avec Healthcheck)
  # ----------------------------------------------------
  loto_app:
    image: tclrcc/loto-app:latest
    container_name: loto_app
    depends_on:
      - loto_db
    environment:
      TZ: Europe/Paris
      SPRING_PROFILES_ACTIVE: prod
      JAVA_OPTS: -XX:+UseG1GC -Xms512m -Xmx3500m
      SPRING_DATASOURCE_URL: jdbc:postgresql://loto_db:5432/lotodb
      SPRING_DATASOURCE_USERNAME: loto
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}
      PORT: 8080
      APP_BASE_URL: https://51-254-133-205.nip.io
      LOTO_SECURITY_REMEMBER_KEY: ${REMEMBER_KEY}
      SPRING_MAIL_USERNAME: tonycoloricchio01@gmail.com
      SPRING_MAIL_PASSWORD: ${MAIL_PASSWORD}
      APP_LOTO_RECIPIENT: tonycoloricchio01@gmail.com
      AI_PASSWORD: admin
    restart: always
    # Plus besoin de "ports: - 8081:8080", l'appli est isolée derrière Caddy.
    # Healthcheck (Docker redémarre l'app si elle plante)
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 4096M

  # ----------------------------------------------------
  # SURVEILLANCE SERVEUR (Uptime Kuma)
  # ----------------------------------------------------
  uptime-kuma:
    image: louislam/uptime-kuma:1
    container_name: uptime-kuma
    restart: always
    ports:
      - "3001:3001"
    volumes:
      - uptime-kuma-data:/app/data

  # ----------------------------------------------------
  # REVERSE PROXY (Caddy pour le HTTPS auto)
  # ----------------------------------------------------
  caddy:
    image: caddy:2-alpine
    container_name: caddy_proxy
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - loto_app

  # ----------------------------------------------------
  # OBSERVABILITE DES LOGS (Dozzle)
  # ----------------------------------------------------
  dozzle:
    image: amir20/dozzle:latest
    container_name: dozzle
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      DOZZLE_USERNAME: tclrcc
      DOZZLE_PASSWORD: Lisandro1608

volumes:
  pgdata:
  caddy_data:
  caddy_config:
  uptime-kuma-data:
