services:
  # ----------------------------------------------------
  # 1. BASE DE DONNÉES (Optimisée pour la charge)
  # ----------------------------------------------------
  loto_db:
    image: postgres:15-alpine
    container_name: loto_db
    environment:
      POSTGRES_DB: lotodb
      POSTGRES_USER: loto
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      TZ: Europe/Paris
    command:
      - "postgres"
      - "-c"
      - "max_connections=100"
      - "-c"
      - "shared_buffers=3GB"
      - "-c"
      - "effective_cache_size=9GB"
      - "-c"
      - "maintenance_work_mem=1GB"
      - "-c"
      - "checkpoint_completion_target=0.9"
      - "-c"
      - "wal_buffers=16MB"
      - "-c"
      - "default_statistics_target=500"
      - "-c"
      - "random_page_cost=1.1"
      - "-c"
      - "effective_io_concurrency=300"
      - "-c"
      - "work_mem=32MB"
      - "-c"
      - "min_wal_size=2GB"
      - "-c"
      - "max_wal_size=8GB"
      - "-c"
      - "max_worker_processes=6"
      - "-c"
      - "max_parallel_workers_per_gather=3"
      - "-c"
      - "max_parallel_workers=6"
    volumes:
      - pgdata:/var/lib/postgresql/data
    restart: always
    networks:
      - loto-network
    deploy:
      resources:
        limits:
          memory: 4G
    logging: &logging_config
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    ports:
      - "5433:5432"

  # ----------------------------------------------------
  # SAUVEGARDE AUTOMATIQUE
  # ----------------------------------------------------
  db_backup:
    image: prodrigestivill/postgres-backup-local
    container_name: loto_db_backup
    restart: always
    depends_on:
      - loto_db
    environment:
      POSTGRES_HOST: loto_db
      POSTGRES_DB: lotodb
      POSTGRES_USER: loto
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      SCHEDULE: "@daily"
      BACKUP_KEEP_DAYS: 7
      TZ: Europe/Paris
    volumes:
      - ./backups:/backups
    networks:
      - loto-network
    logging: *logging_config

  # ----------------------------------------------------
  # 3. CACHE DISTRIBUÉ (NOUVEAU - INDISPENSABLE)
  # ----------------------------------------------------
  redis_cache:
    image: redis:alpine
    container_name: redis_cache
    restart: always
    networks:
      - loto-network
    deploy:
      resources:
        limits:
          memory: 512M # Redis est très léger, 512Mo suffit largement
    logging: *logging_config

  # NOUVEAU SERVICE IA
  loto-ai:
    build:
      context: .
      dockerfile: Dockerfile.python
    container_name: loto-ai-engine
    environment:
      - TZ=Europe/Paris
    ports:
      - "8000:8000"
    volumes:
      # PERSISTANCE DES MODÈLES :
      # Ce volume permet de garder les modèles entraînés même si le conteneur redémarre
      - ./models:/app/models
      # On monte aussi le CSV d'historique pour l'entraînement manuel
      - ./loto_history.csv:/app/loto_history.csv
    restart: unless-stopped

  # ----------------------------------------------------
  # 2. APPLICATION SPRING BOOT (Tuning JVM & Healthcheck)
  # ----------------------------------------------------
  loto_app:
    image: tclrcc/loto-app:latest
    container_name: loto_app
    depends_on:
      - loto_db
      - loto-ai
      - redis_cache
    environment:
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      TZ: Europe/Paris
      SPRING_PROFILES_ACTIVE: prod
        # L'app Java pourra contacter l'IA via ce nom d'hôte
      LOTO_AI_URL: http://loto-ai:8000/predict
      JAVA_OPTS: "-XX:MaxRAMPercentage=60.0 -XX:InitialRAMPercentage=40.0 -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:ParallelGCThreads=6"

      # DB CONFIG
      SPRING_DATASOURCE_URL: jdbc:postgresql://loto_db:5432/lotodb
      SPRING_DATASOURCE_USERNAME: loto
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}

      # REDIS CONFIG (Le lien magique)
      SPRING_DATA_REDIS_HOST: redis_cache
      SPRING_DATA_REDIS_PORT: 6379

      # APP CONFIG
      PORT: 8080
      APP_BASE_URL: https://51-254-133-205.nip.io
      LOTO_SECURITY_REMEMBER_KEY: ${REMEMBER_KEY}
      SPRING_MAIL_USERNAME: tonycoloricchio01@gmail.com
      SPRING_MAIL_PASSWORD: ${MAIL_PASSWORD}
      APP_LOTO_RECIPIENT: tonycoloricchio01@gmail.com
      AI_PASSWORD: admin
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '5.0'
          memory: 7G
    networks:
      - loto-network
    logging: *logging_config

  # ----------------------------------------------------
  # MONITORING AVANCÉ
  # ----------------------------------------------------
  netdata:
    image: netdata/netdata
    container_name: netdata
    restart: always
    hostname: loto-monitor
    cap_add:
      - SYS_PTRACE
    security_opt:
      - apparmor:unconfined
    volumes:
      - netdatalib:/var/lib/netdata
      - netdatacache:/var/cache/netdata
      - /etc/passwd:/host/etc/passwd:ro
      - /etc/group:/host/etc/group:ro
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    ports:
      - "19999:19999"
    logging: *logging_config

  uptime-kuma:
    image: louislam/uptime-kuma:1
    container_name: uptime-kuma
    restart: always
    ports:
      - "3001:3001"
    volumes:
      - uptime-kuma-data:/app/data
    networks:
      - loto-network
    logging: *logging_config

  # ----------------------------------------------------
  # REVERSE PROXY
  # ----------------------------------------------------
  caddy:
    image: caddy:2-alpine
    container_name: caddy_proxy
    restart: always
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - loto_app
    networks:
      - loto-network
    logging: *logging_config

  # ----------------------------------------------------
  # LOGS
  # ----------------------------------------------------
  dozzle:
    image: amir20/dozzle:latest
    container_name: dozzle
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      DOZZLE_USERNAME: tclrcc
      DOZZLE_PASSWORD: Lisandro1608
    networks:
      - loto-network
    logging: *logging_config

# Réseau interne
networks:
  loto-network:
    driver: bridge

volumes:
  pgdata:
  caddy_data:
  caddy_config:
  uptime-kuma-data:
  netdatalib:
  netdatacache:
