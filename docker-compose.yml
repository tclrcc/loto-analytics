services:
  # ----------------------------------------------------
  # 1. BASE DE DONNÉES (Optimisée pour la charge)
  # ----------------------------------------------------
  loto_db:
    image: postgres:15-alpine # Version Alpine plus légère
    container_name: loto_db
    environment:
      POSTGRES_DB: lotodb
      POSTGRES_USER: loto
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      TZ: Europe/Paris
    # Tuning Performance DB pour un VPS moyen
    command: >
      postgres 
      -c shared_buffers=256MB 
      -c effective_cache_size=768MB 
      -c maintenance_work_mem=64MB 
      -c checkpoint_completion_target=0.7 
      -c wal_buffers=16MB 
      -c default_statistics_target=100 
      -c random_page_cost=1.1 
      -c effective_io_concurrency=200
    volumes:
      - pgdata:/var/lib/postgresql/data
    restart: always
    networks:
      - loto-network
    deploy:
      resources:
        limits:
          memory: 1G # Augmenté pour encaisser les requêtes historiques
    logging: &logging_config # Configuration partagée des logs
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ----------------------------------------------------
  # SAUVEGARDE AUTOMATIQUE
  # ----------------------------------------------------
  db_backup:
    image: prodrigestivill/postgres-backup-local
    container_name: loto_db_backup
    restart: always
    depends_on:
      - loto_db
    environment:
      POSTGRES_HOST: loto_db
      POSTGRES_DB: lotodb
      POSTGRES_USER: loto
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      SCHEDULE: "@daily"
      BACKUP_KEEP_DAYS: 7
      TZ: Europe/Paris
    volumes:
      - ./backups:/backups
    networks:
      - loto-network
    logging: *logging_config

  # ----------------------------------------------------
  # 2. APPLICATION SPRING BOOT (Tuning JVM & Healthcheck)
  # ----------------------------------------------------
  loto_app:
    image: tclrcc/loto-app:latest
    container_name: loto_app
    depends_on:
      - loto_db
    environment:
      TZ: Europe/Paris
      SPRING_PROFILES_ACTIVE: prod
      # OPTIMISATION MAJEURE :
      # -XX:MaxRAMPercentage=75.0 : Utilise 75% de la RAM allouée au conteneur (plus souple que Xmx)
      # -XX:+UseG1GC : Garbage Collector parfait pour les applis > 4Go
      # -XX:+UseStringDeduplication : Réduit la RAM car bcp de chaînes identiques dans tes stats
      JAVA_OPTS: "-XX:MaxRAMPercentage=75.0 -XX:InitialRAMPercentage=50.0 -XX:+UseG1GC -XX:+UseStringDeduplication"
      SPRING_DATASOURCE_URL: jdbc:postgresql://loto_db:5432/lotodb
      SPRING_DATASOURCE_USERNAME: loto
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}
      PORT: 8080
      APP_BASE_URL: https://51-254-133-205.nip.io
      LOTO_SECURITY_REMEMBER_KEY: ${REMEMBER_KEY}
      SPRING_MAIL_USERNAME: tonycoloricchio01@gmail.com
      SPRING_MAIL_PASSWORD: ${MAIL_PASSWORD}
      APP_LOTO_RECIPIENT: tonycoloricchio01@gmail.com
      AI_PASSWORD: admin
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s # Laisse 1 minute au démarrage (calculs initiaux) avant de tuer l'app
    deploy:
      resources:
        limits:
          memory: 4G # Java prendra 75% de ça (soit 3Go) automatiquement
    networks:
      - loto-network
    logging: *logging_config

  # ----------------------------------------------------
  # MONITORING AVANCÉ (Nouveau !)
  # ----------------------------------------------------
  netdata:
    image: netdata/netdata
    container_name: netdata
    restart: always
    hostname: loto-monitor
    cap_add:
      - SYS_PTRACE
    security_opt:
      - apparmor:unconfined
    volumes:
      - netdatalib:/var/lib/netdata
      - netdatacache:/var/cache/netdata
      - /etc/passwd:/host/etc/passwd:ro
      - /etc/group:/host/etc/group:ro
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    ports:
      - "19999:19999" # Dashboard temps réel impressionnant
    logging: *logging_config

  uptime-kuma:
    image: louislam/uptime-kuma:1
    container_name: uptime-kuma
    restart: always
    ports:
      - "3001:3001"
    volumes:
      - uptime-kuma-data:/app/data
    networks:
      - loto-network
    logging: *logging_config

  # ----------------------------------------------------
  # REVERSE PROXY
  # ----------------------------------------------------
  caddy:
    image: caddy:2-alpine
    container_name: caddy_proxy
    restart: always
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp" # Support HTTP/3 (QUIC) pour la vitesse mobile
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - loto_app
    networks:
      - loto-network
    logging: *logging_config

  # ----------------------------------------------------
  # LOGS
  # ----------------------------------------------------
  dozzle:
    image: amir20/dozzle:latest
    container_name: dozzle
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      DOZZLE_USERNAME: tclrcc
      DOZZLE_PASSWORD: Lisandro1608
    networks:
      - loto-network
    logging: *logging_config

# Réseau interne pour isoler la DB du web
networks:
  loto-network:
    driver: bridge

volumes:
  pgdata:
  caddy_data:
  caddy_config:
  uptime-kuma-data:
  netdatalib:
  netdatacache:
